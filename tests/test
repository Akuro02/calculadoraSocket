SERVER="./../server"
CLIENT="./../client"

start_server() {
    ${SERVER} &
    SERVER_PID=$!
    echo "Servidor iniciado com PID: $SERVER_PID"
    sleep 1  # Aguarda um momento para garantir que o servidor esteja pronto
}

stop_server() {
    kill $SERVER_PID
    echo "Servidor com PID $SERVER_PID parado"
}

run_test(){
    local input="$1"
    local expected_output="$2"
    local test_name="$3"

    local output=$(echo -e "$input" | $CLIENT | grep 'Resultado: ')

    if [[ "$output" == *"$expected_output"* ]]; then
        echo "✅ Teste '$test_name' passou."
        echo "Entrada injetada: '$input'"
        echo "     Esperado: '$expected_output'"
        echo "     Obtido:   '$output'"
    else
        echo "  ❌ Teste '$test_name' falhou."
        echo "     Entrada injetada: '$input'"
        echo "     Esperado: '$expected_output'"
        echo "     Obtido:   '$output'"
    fi
        
}

# --- Cenario de teste ---
echo "Iniciando servidor para testes..."
start_server

# TESTE 1
run_test "1\nADD 10 20\n" "Resultado: OK 30.000000" "SOMA 10 20"

run_test "1\nDIV 10 20\n" "Resultado: OK 0.500000" "DIV 10 20"

run_test "1\nDIV 10 0\n" "Resultado: ERR divisao_por_zero" "DIV 10 0"

run_test "1\nABC 10 0\n" "Resultado: ERR operador_invalido" "ABC 10 0"

run_test "1\nADD 10\n" "Resultado: OK 10.000000" "ADD 10"

# Encerra o servidor
stop_server

exit 0